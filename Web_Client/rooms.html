<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ph√≤ng Chat C·ªông ƒê·ªìng</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f0f2f5;
    }
    
    /* === S·ª¨A HEADER V√Ä N√öT THO√ÅT === */
    header {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      font-size: 1.2em;
      
      /* Th√™m Flexbox ƒë·ªÉ cƒÉn ch·ªânh */
      display: flex;
      justify-content: space-between; /* ƒê·∫©y 2 m·ª•c ra 2 b√™n */
      align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
      padding: 10px 20px; 
    }

    #exit-btn {
      background-color: #dc3545; /* M√†u ƒë·ªè */
      color: white;
      border: none;
      
      padding: 5px 8px; /* K√≠ch th∆∞·ªõc nh·ªè */
      font-size: 0.9em;   /* Ch·ªØ nh·ªè */

      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    #exit-btn:hover {
      background-color: #c82333;
    }
    /* === H·∫æT PH·∫¶N S·ª¨A === */

    main {
      flex: 1;
      display: flex;
      overflow: hidden; /* NgƒÉn scroll ·ªü main */
    }
    #chat-container {
      flex: 3;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ccc;
    }
    #chat-box {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background-color: #ffffff;
    }
    #user-list-container {
      flex: 1;
      padding: 10px;
      background-color: #f8f8f8;
      border-left: 1px solid #ccc;
      overflow-y: auto;
    }
    footer {
      display: flex;
      padding: 10px;
      background-color: #eee;
      border-top: 1px solid #ccc;
    }
    #msgInput {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-right: 10px;
      font-size: 1em;
    }
    #send-btn {
      width: 100px;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    #send-btn:hover {
      background-color: #0056b3;
    }
    
    /* === C√°c ki·ªÉu tin nh·∫Øn === */
    .msg-item { margin-bottom: 8px; }
    .msg-system {
      color: gray;
      font-style: italic;
      text-align: center;
      font-size: 0.9em;
    }
    .msg-mine {
      text-align: right;
      color: #0056b3;
    }
    .msg-other {
      text-align: left;
    }
    .msg-private {
      background-color: #fffbe6;
      color: #5d4c0c;
      border-left: 3px solid #ffd666;
      padding: 5px 10px;
      border-radius: 3px;
    }
    .username { font-weight: bold; }
    
    /* === Danh s√°ch User === */
    #user-list-container h3 {
        margin-top: 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }
    .user-item {
        display: block;
        margin: 5px 0;
        color: #333;
        font-weight: bold;
    }
    .user-item::before {
        content: "üü¢"; /* Ch·∫•m xanh online */
        font-size: 0.7em;
        margin-right: 8px;
    }

  </style>
</head>
<body>
  <header>
    <span>Ph√≤ng Chat C·ªông ƒê·ªìng</span>
    <button id="exit-btn">Tho√°t ‚ûî</button>
  </header>

  <main>
    <div id="chat-container">
      <div id="chat-box">
        </div>
    </div>

    <div id="user-list-container">
      <h3>ƒêang online (0)</h3>
      <div id="user-list">
        </div>
    </div>
  </main>

  <footer>
    <input id="msgInput" placeholder="Nh·∫≠p tin nh·∫Øn... (d√πng @T√™nUser ƒë·ªÉ chat ri√™ng)" />
    <button id="send-btn">G·ª≠i</button>
  </footer>

  <script>
    // 1. L·∫§Y USERNAME V√Ä KI·ªÇM TRA
    const username = localStorage.getItem("username");
    if (!username) {
      alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
      window.location.href = "index.html"; // Quay v·ªÅ trang ƒëƒÉng nh·∫≠p
    }

    // 2. L·∫§Y C√ÅC TH√ÄNH PH·∫¶N GIAO DI·ªÜN
    const chatBox = document.getElementById("chat-box");
    const userListDiv = document.getElementById("user-list");
    const userListHeader = document.querySelector("#user-list-container h3");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("send-btn");
    const exitBtn = document.getElementById("exit-btn"); // Th√™m n√∫t Tho√°t

    // 3. K·∫æT N·ªêI WEBSOCKET
    // !!! QUAN TR·ªåNG: Thay ƒë·ªïi IP n·∫øu b·∫°n test LAN
    // const ws_ip = "192.168.1.10"; // V√≠ d·ª• Test LAN (IP m√°y th·∫≠t)
    const ws_ip = "127.0.0.1"; // Test ·ªü m√°y (localhost)
    
    // ƒê·∫£m b·∫£o b·∫°n ƒë√£ s·ª≠a HOST = '0.0.0.0' trong server.py v√† gateway.py
    // v√† m·ªü Firewall port 12345, 8765 n·∫øu test LAN
    
    const ws = new WebSocket(`ws://${ws_ip}:8765`); // K·∫øt n·ªëi t·ªõi Gateway

    // 4. C√ÅC H√ÄM H·ªñ TR·ª¢
    
    /** Hi·ªÉn th·ªã tin nh·∫Øn l√™n chat box */
    function displayMessage(message, type) {
      const msgDiv = document.createElement("div");
      msgDiv.className = `msg-item ${type}`; // G√°n class CSS
      msgDiv.innerHTML = message; // D√πng innerHTML ƒë·ªÉ nh·∫≠n di·ªán <br> v√† <strong>
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight; // T·ª± cu·ªôn xu·ªëng cu·ªëi
    }

    /** C·∫≠p nh·∫≠t danh s√°ch user online */
    function updateUserList(users) {
      userListHeader.innerText = `ƒêang online (${users.length})`;
      userListDiv.innerHTML = ""; // X√≥a danh s√°ch c≈©
      users.forEach((user) => {
        const userDiv = document.createElement("div");
        userDiv.className = "user-item";
        userDiv.innerText = user;
        
        userDiv.style.cursor = "pointer";
        userDiv.title = `Click ƒë·ªÉ chat ri√™ng v·ªõi ${user}`;
        userDiv.onclick = () => {
            msgInput.value = `@${user} `;
            msgInput.focus();
        };
        
        userListDiv.appendChild(userDiv);
      });
    }

    // 5. X·ª¨ L√ù S·ª∞ KI·ªÜN WEBSOCKET
    
    /** Khi m·ªü k·∫øt n·ªëi, g·ª≠i tin "join" */
    ws.onopen = () => {
      displayMessage("ƒê√£ k·∫øt n·ªëi t·ªõi server...", "msg-system");
      const joinPkg = {
        type: "join",
        sender: username,
      };
      ws.send(JSON.stringify(joinPkg));
    };

    /** Khi ƒë√≥ng k·∫øt n·ªëi */
    ws.onclose = () => {
      displayMessage("ƒê√£ m·∫•t k·∫øt n·ªëi t·ªõi server.", "msg-system");
      userListHeader.innerText = "ƒê√£ ng·∫Øt k·∫øt n·ªëi";
    };

    /** Khi c√≥ l·ªói */
    ws.onerror = (error) => {
      displayMessage("L·ªói k·∫øt n·ªëi. H√£y F5 trang.", "msg-system");
      console.error("L·ªói WebSocket:", error);
    };

    /** KHI NH·∫¨N ƒê∆Ø·ª¢C TIN NH·∫ÆN T·ª™ SERVER (qua Gateway) */
    ws.onmessage = (event) => {
      try {
        const pkg = JSON.parse(event.data);
        const sender = pkg.sender || "Server";
        const message = pkg.message || "";

        switch (pkg.type) {
          case "message": // Tin nh·∫Øn chung
            if (sender === username) {
              displayMessage(`<span class="username">B·∫°n:</span> ${message}`, "msg-mine");
            } else {
              displayMessage(`<span class="username">${sender}:</span> ${message}`, "msg-other");
            }
            break;
            
          case "private": // Tin nh·∫Øn RI√äNG nh·∫≠n ƒë∆∞·ª£c
            displayMessage(
              `<span class="username">[PM t·ª´ ${sender}]:</span> ${message}`,
              "msg-private"
            );
            break;

          case "private_sent": // X√°c nh·∫≠n tin ri√™ng ƒê√É G·ª¨I
            displayMessage(
              `<span class="username">[PM ƒë√£ g·ª≠i ƒë·∫øn ${pkg.to_user}]:</span> ${message}`,
              "msg-private"
            );
            break;

          case "user_list": // C·∫≠p nh·∫≠t danh s√°ch user
            updateUserList(pkg.users || []);
            break;
            
          case "info": // Th√¥ng b√°o t·ª´ server (join/leave)
          case "error": // L·ªói t·ª´ server (user not found)
            displayMessage(`[${sender}]: ${message}`, "msg-system");
            break;

          default:
            console.log("Nh·∫≠n ƒë∆∞·ª£c g√≥i tin l·∫°:", pkg);
        }
      } catch (e) {
        console.error("L·ªói parse JSON:", e, event.data);
      }
    };

    // 6. X·ª¨ L√ù G·ª¨I TIN
    function sendMessage() {
      const msg = msgInput.value.trim();
      if (!msg) return; // Kh√¥ng g·ª≠i tin r·ªóng

      const msgPkg = {
        type: "message",
        sender: username,
        message: msg,
      };
      ws.send(JSON.stringify(msgPkg));
      
      // N·∫øu l√† tin nh·∫Øn c·ªßa m√¨nh (KH√îNG ph·∫£i @), server.py s·∫Ω broadcast l·∫°i
      // N·∫øu l√† tin @, server.py s·∫Ω g·ª≠i type "private_sent"
      // N√™n ch√∫ng ta kh√¥ng c·∫ßn t·ª± hi·ªÉn th·ªã ·ªü ƒë√¢y.
      
      msgInput.value = ""; // X√≥a input
      msgInput.focus();
    }

    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // 7. X·ª¨ L√ù THO√ÅT (Th√™m m·ªõi)
    /** H√†m x·ª≠ l√Ω tho√°t chat */
    function exitChat() {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi ph√≤ng chat?")) {
        return;
      }

      const exitPkg = {
        type: "exit", //
        sender: username
      };
      ws.send(JSON.stringify(exitPkg));
      ws.close();
      localStorage.removeItem("username");
      displayMessage("B·∫°n ƒë√£ tho√°t. ƒêang chuy·ªÉn h∆∞·ªõng...", "msg-system");

      setTimeout(() => {
        window.location.href = "index.html";
      }, 1500); 
    }
    
    exitBtn.onclick = exitChat;

  </script>
</body>
</html>